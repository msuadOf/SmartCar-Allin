C251 COMPILER V5.60.0,  MPU6500                                                            15/05/23  16:30:08  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE MPU6500
OBJECT MODULE PLACED IN .\MDK\Obj\MPU6500.obj
COMPILER INVOKED BY: D:\Programs\keil_v5\C251\BIN\C251.EXE CORE\Src\MPU6500.c XSMALL INTR2 BROWSE INCDIR(.\Driver;.\Driv
                    -er\Inc;.\Driver\Isr;.\CORE\Inc;.\bsp\include) DEBUG PRINT(.\MDK\List\MPU6500.lst) TABS(2) OBJECT(.\MDK\Obj\MPU6500.obj) 

stmt  level    source

    1          #include <stdio.h>
    2          #include "MPU6500.h"
*** WARNING C317 IN LINE 39 OF \STC32\SmartCar-Allin\Driver\type_def.h: attempt to redefine macro 'NULL'
    3          /* Ñ¡ÔñÊ¹ÓÃSPI»¹ÊÇI2C½øÐÐÍ¨Ñ¶Äó£¬µ±¹ûÈ»ÊÇSPIÄå */
    4          #define MPU6500_USING_SPI
    5          // #define MPU6500_USING_I2C
    6          
    7          /**
    8           *
    9           * ********************************************************
   10           *
   11           *  ¼æÈÝ²ãÄó HAL_level start
   12           *
   13           * ********************************************************
   14           *
   15           **/
   16          
   17          /*
   18          ====================================
   19              ||
   20              ||
   21              ||  Ó²¼þÊµÏÖ²ã£¬¸ü¸ÄÉè±¸µÄ»°ÇëÔÚÕâÀï½øÐÐÊµÏÖ
   22              ||
   23              ||
   24          +++++++++++++++++++++++++++++++++++++++++++++++++++++++
   25          */
   26          #include "config.h"
   27          #include "bsp.h"
   28          /**
   29           * @brief Í³Ò»API½ÓÈë
   30           *
   31           */
   32          
   33          /* STC32G_Delay¿âÓÐÏà¹ØÊµÏÖº¯Êý½øÐÐÌæ´ú */
   34          #include "STC32G_Delay.h"
   35          void mpu6500_delay_ms(int ms)
   36          {
   37   1          delay_ms(ms);
   38   1      }
   39          #ifdef MPU6500_USING_SPI
   40          void hal_spi_init()
   41          {
   42   1          bsp_spi_init();
   43   1      }
   44          void hal_spi_read(unsigned char addr, unsigned char *buffer, int len)
   45          {
   46   1          bsp_spi_read(addr, buffer, len);
   47   1      }
   48          
   49          void hal_spi_write(unsigned char addr, unsigned char *buffer, int len)
   50          {
   51   1          bsp_spi_write(addr, buffer, len);
   52   1      }
   53          #endif
   54          
   55          #ifdef MPU6500_USING_I2C
               void hal_i2c_init()
               {
C251 COMPILER V5.60.0,  MPU6500                                                            15/05/23  16:30:08  PAGE 2   

                   I2C_soft_GPIO_Config();
               }
               void hal_i2c_read(unsigned char addr, unsigned char *buffer, int len)
               {
               }
               
               void hal_i2c_write(unsigned char addr, unsigned char *buffer, int len)
               {
               }
               #endif
   68          void MPU6500_Peripheral_Init()
   69          {
   70   1      #ifdef MPU6500_USING_I2C
                   hal_i2c_init();
               #endif
   73   1      #ifdef MPU6500_USING_SPI
   74   1          hal_spi_init();
   75   1      #endif
   76   1      }
   77          void MPU6500_Read(unsigned char addr, unsigned char *buffer, int len)
   78          {
   79   1      #ifdef MPU6500_USING_I2C
                   hal_i2c_read(addr, buffer, len);
               #endif
   82   1      #ifdef MPU6500_USING_SPI
   83   1          hal_spi_read(addr, buffer, len);
   84   1      #endif
   85   1      }
   86          
   87          void MPU6500_Write(unsigned char addr, unsigned char *buffer, int len)
   88          {
   89   1      #ifdef MPU6500_USING_I2C
                   hal_i2c_write(addr, buffer, len);
               #endif
   92   1      #ifdef MPU6500_USING_SPI
   93   1          hal_spi_write(addr, buffer, len);
   94   1      #endif
   95   1      }
   96          /**
   97           * *******************************************
   98           *
   99           *  ¼æÈÝ²ãÄó end
  100           *
  101           * *******************************************
  102           * */
  103          
  104          
  105          
  106          void MPU6500_Write_u8(unsigned char addr, u8 buffer){
  107   1          u8 reg_buffer=buffer;
  108   1        MPU6500_Write(MPU6500_GYRO_CONFIG,reg_buffer,1);
*** WARNING C40 IN LINE 108 OF CORE\Src\MPU6500.c: 'unsigned char' converted to 'far' pointer
  109   1      }
*** WARNING C47 IN LINE 106 OF CORE\Src\MPU6500.c: 'addr': unreferenced parameter
  110          // void MPU6500_Write_u16(unsigned char addr, u16 *buffer){
  111          //     u8 buffer_u8[2];
  112          //     buffer_u8[]
  113          //     MPU6500_Write(addr, buffer, 1);
  114          // }
  115          // void MPU6500_Write_u32(unsigned char addr, u32 *buffer){
  116          
  117          // }
  118          /* ¶¨ÒåMPU6500³õÊ¼»¯º¯Êý */
  119          void MPU6500_Init()
  120          {
  121   1          unsigned char reg_buffer;
C251 COMPILER V5.60.0,  MPU6500                                                            15/05/23  16:30:08  PAGE 3   

  122   1      
  123   1          MPU6500_Peripheral_Init();
  124   1      
  125   1          // /* ÉèÖÃÍÓÂÝÒÇ²ÉÑùÂÊÎª1KHz */
  126   1          // reg_buffer = 0x00; //·ÖÆµÏµÊýÎª0
  127   1          // MPU6500_Write(MPU6500_SMPLRT_DIV, &reg_buffer, 1);
  128   1      
  129   1          // /* ÉèÖÃ¼ÓËÙ¶È¼Æ²ÉÑùÂÊÎª1KHz */
  130   1          // reg_buffer = 0x00; //·ÖÆµÏµÊýÎª0
  131   1          // MPU6500_Write(MPU6500_ACCEL_CONFIG, &reg_buffer, 1);
  132   1      
  133   1          /* ÉèÖÃÍÓÂÝÒÇ×Ô¼ì */
  134   1          reg_buffer = 0x80;
  135   1          MPU6500_Write(MPU6500_SELF_TEST_X_GYRO, &reg_buffer, 1);
  136   1          // µÈ´ý100ms£¬ÈÃÍÓÂÝÒÇÍê³É×Ô¼ì
  137   1          delay_ms(100);
  138   1      
  139   1          /* ¹Ø±ÕÍÓÂÝÒÇ×Ô¼ì */
  140   1          reg_buffer = 0x00;
  141   1          MPU6500_Write(MPU6500_SELF_TEST_X_GYRO, &reg_buffer, 1);
  142   1      
  143   1          /* ´ò¿ªÍÓÂÝÒÇºÍ¼ÓËÙ¶È¼Æ */
  144   1          reg_buffer = 0x00;
  145   1          MPU6500_Write(MPU6500_PWR_MGMT_1, &reg_buffer, 1);
  146   1      }
  147          
  148          // /* ¶¨ÒåMPU6500ÁùÖáÊý¾Ý»ñÈ¡º¯Êý */
  149          // void MPU6500_get_buffer(float *gyro_buffer, float *acc_buffer)
  150          // {
  151          //     unsigned char buf[14];
  152          
  153          //     /* ¶ÁÈ¡ÍÓÂÝÒÇºÍ¼ÓËÙ¶È¼ÆÊý¾Ý */
  154          //     MPU6500_Read(MPU6500_ACCEL_XOUT_H, buf, (3 + 1 + 3) * 2); // 3¸ögyroÖáÊý¾Ý+1¸ötempÊý¾Ý+3¸öaccÊý¾Ý
  155          
  156          //     /* ½âÎöÍÓÂÝÒÇÊý¾Ý */
  157          //     gyro_buffer[0] = (float)(((short)buf[8] << 8) | buf[9]) / 32768.0f * 250.0f;
  158          //     gyro_buffer[1] = (float)(((short)buf[10] << 8) | buf[11]) / 32768.0f * 250.0f;
  159          //     gyro_buffer[2] = (float)(((short)buf[12] << 8) | buf[13]) / 32768.0f * 250.0f;
  160          
  161          //     /* ½âÎö¼ÓËÙ¶È¼ÆÊý¾Ý */
  162          //     acc_buffer[0] = (float)(((short)buf[0] << 8) | buf[1]) / 32768.0f * 2.0f;
  163          //     acc_buffer[1] = (float)(((short)buf[2] << 8) | buf[3]) / 32768.0f * 2.0f;
  164          //     acc_buffer[2] = (float)(((short)buf[4] << 8) | buf[5]) / 32768.0f * 2.0f;
  165          // }
  166          
  167          void MPU6500_get_buffer(float *gyro_buffer, float *acc_buffer)
  168          {
  169   1          static float gyroLast[3] = {0, 0, 0}; // ÉÏÒ»´ÎµÄÍÓÂÝÒÇÊý¾Ý
  170   1          static float accLast[3] = {0, 0, 0}; // ÉÏÒ»´ÎµÄ¼ÓËÙ¶È¼ÆÊý¾Ý
  171   1      
  172   1          unsigned char buf[14];
  173   1              float alphaGyro = 0.5f; // ÍÓÂÝÒÇÊý¾ÝµÄÂË²¨ÏµÊý
  174   1              float alphaAcc = 0.5f; // ¼ÓËÙ¶È¼ÆÊý¾ÝµÄÂË²¨ÏµÊý
  175   1      
  176   1          /* ¶ÁÈ¡ÍÓÂÝÒÇºÍ¼ÓËÙ¶È¼ÆÊý¾Ý */
  177   1          MPU6500_Read(MPU6500_ACCEL_XOUT_H, buf, (3 + 1 + 3) * 2); // 3¸ögyroÖáÊý¾Ý+1¸ötempÊý¾Ý+3¸öaccÊý¾Ý
  178   1      
  179   1          /* ½âÎöÍÓÂÝÒÇÊý¾Ý£¬Ê¹ÓÃ»¥²¹ÂË²¨Æ½»¬Êý¾Ý */
  180   1      
  181   1          gyro_buffer[0] = (float)(((short)buf[8] << 8) | buf[9]) / 32768.0f * 250.0f;
  182   1          gyro_buffer[1] = (float)(((short)buf[10] << 8) | buf[11]) / 32768.0f * 250.0f;
  183   1          gyro_buffer[2] = (float)(((short)buf[12] << 8) | buf[13]) / 32768.0f * 250.0f;
  184   1          gyro_buffer[0] = alphaGyro * gyroLast[0] + (1 - alphaGyro) * gyro_buffer[0];
  185   1          gyro_buffer[1] = alphaGyro * gyroLast[1] + (1 - alphaGyro) * gyro_buffer[1];
  186   1          gyro_buffer[2] = alphaGyro * gyroLast[2] + (1 - alphaGyro) * gyro_buffer[2];
  187   1          gyroLast[0] = gyro_buffer[0];
C251 COMPILER V5.60.0,  MPU6500                                                            15/05/23  16:30:08  PAGE 4   

  188   1          gyroLast[1] = gyro_buffer[1];
  189   1          gyroLast[2] = gyro_buffer[2];
  190   1      
  191   1          /* ½âÎö¼ÓËÙ¶È¼ÆÊý¾Ý£¬Ê¹ÓÃ»¥²¹ÂË²¨Æ½»¬Êý¾Ý */
  192   1      
  193   1          acc_buffer[0] = (float)(((short)buf[0] << 8) | buf[1]) / 32768.0f * 2.0f;
  194   1          acc_buffer[1] = (float)(((short)buf[2] << 8) | buf[3]) / 32768.0f * 2.0f;
  195   1          acc_buffer[2] = (float)(((short)buf[4] << 8) | buf[5]) / 32768.0f * 2.0f;
  196   1          acc_buffer[0] = alphaAcc * accLast[0] + (1 - alphaAcc) * acc_buffer[0];
  197   1          acc_buffer[1] = alphaAcc * accLast[1] + (1 - alphaAcc) * acc_buffer[1];
  198   1          acc_buffer[2] = alphaAcc * accLast[2] + (1 - alphaAcc) * acc_buffer[2];
  199   1          accLast[0] = acc_buffer[0];
  200   1          accLast[1] = acc_buffer[1];
  201   1          accLast[2] = acc_buffer[2];
  202   1      }
  203          
  204          
  205          // int main()
  206          // {
  207          //     float gyro_buffer[3], acc_buffer[3];
  208          
  209          //     /* ³õÊ¼»¯MPU6500 */
  210          //     mpu6500_init();
  211          
  212          //     while (1)
  213          //     {
  214          //         /* »ñÈ¡ÍÓÂÝÒÇºÍ¼ÓËÙ¶È¼ÆÊý¾Ý */
  215          //         mpu6500_get_buffer(gyro_buffer, acc_buffer);
  216          
  217          //         /* ´òÓ¡Êý¾Ý */
  218          //         printf("Gyro: %.2f, %.2f, %.2f, Acc: %.2f, %.2f, %.2f\n", gyro_buffer[0], gyro_buffer[1], gyro
             -_buffer[2], acc_buffer[0], acc_buffer[1], acc_buffer[2]);
  219          
  220          //         /* ÑÓÊ±Ò»¶ÎÊ±¼ä */
  221          //         delay_ms(10);
  222          //     }
  223          
  224          //     return 0;
  225          // }
  226          
  227          //void MPU6500_SelfCalibration(void)
  228          //{
  229          //    unsigned char buffer;
  230          //    unsigned char rawData[6];      // Ô­Ê¼´«¸ÐÆ÷Êý¾Ý
  231          //    float gyroBias[3] = {0, 0, 0}; // ÍÓÂÝÒÇÆ«ÖÃ
  232          //    int i, j;
  233          //    // ¼ÓËÙ¶È¼Æ×ÔÐ£×¼
  234          //    float accelBias[3] = {0, 0, 0}; // ¼ÓËÙ¶È¼ÆÆ«ÖÃ
  235          
  236          //    // ÎÂ¶ÈÎÈ¶¨»¯
  237          //    buffer = 0x40;
  238          //    MPU6500_Write(0x1A, &buffer, 1); // ½«Config¼Ä´æÆ÷µÄTEMP_FIFO_ENÎ»ÖÃÎª1£¬Ê¹ÄÜÎÂ¶È´«¸ÐÆ÷
  239          //    mpu6500_delay_ms(200);           // µÈ´ý200ms£¬ÈÃÎÂ¶ÈÎÈ¶¨
  240          
  241          //    // ÍÓÂÝÒÇ×ÔÐ£×¼
  242          //    for (i = 0; i < 1000; i++) // È¡1000¸öÑù±¾½øÐÐÆ½¾ùÖµ¼ÆËã
  243          //    {
  244          //        MPU6500_Read(0x43, rawData, 6); // ¶ÁÈ¡ÍÓÂÝÒÇX¡¢Y¡¢ZÖáµÄÔ­Ê¼Êý¾Ý
  245          //        for (j = 0; j < 3; j++)
  246          //        {
  247          //            gyroBias[j] += (float)(((int16_t)rawData[j * 2] << 8) | rawData[j * 2 + 1]); // ÀÛ¼ÓÃ¿¸öÖáµ
             -ÄÔ­Ê¼Êý¾Ý
  248          //        }
  249          //        mpu6500_delay_ms(10);
  250          //    }
  251          //    for (i = 0; i < 3; i++)
C251 COMPILER V5.60.0,  MPU6500                                                            15/05/23  16:30:08  PAGE 5   

  252          //    {
  253          //        gyroBias[i] /= 1000.0f; // ¼ÆËãÆ½¾ùÖµ
  254          //    }
  255          //    MPU6500_Write(0x13, (unsigned char *)&gyroBias[0], 2); // ½«ÍÓÂÝÒÇXÖáµÄÆ«ÖÃÐ´ÈëMPU6500Ð¾Æ¬µÄGYRO_X_
             -OFFS_HºÍGYRO_X_OFFS_L¼Ä´æÆ÷ÖÐ
  256          //    MPU6500_Write(0x15, (unsigned char *)&gyroBias[1], 2); // ½«ÍÓÂÝÒÇYÖáµÄÆ«ÖÃÐ´ÈëMPU6500Ð¾Æ¬µÄGYRO_Y_
             -OFFS_HºÍGYRO_Y_OFFS_L¼Ä´æÆ÷ÖÐ
  257          //    MPU6500_Write(0x17, (unsigned char *)&gyroBias[2], 2); // ½«ÍÓÂÝÒÇZÖáµÄÆ«ÖÃÐ´ÈëMPU6500Ð¾Æ¬µÄGYRO_Z_
             -OFFS_HºÍGYRO_Z_OFFS_L¼Ä´æÆ÷ÖÐ
  258          
  259          //    // ¼ÓËÙ¶È¼Æ×ÔÐ£×¼
  260          //    for (i = 0; i < 500; i++) // È¡500¸öÑù±¾½øÐÐÆ½¾ùÖµ¼ÆËã
  261          //    {
  262          //        MPU6500_Read(0x3B, rawData, 6); // ¶ÁÈ¡¼ÓËÙ¶È¼ÆX¡¢Y¡¢ZÖáµÄÔ­Ê¼Êý¾Ý
  263          //        for (j = 0; j < 3; j++)
  264          //        {
  265          //            accelBias[j] += (float)(((int16_t)rawData[j * 2] << 8) | rawData[j * 2 + 1]); // ÀÛ¼ÓÃ¿¸öÖá
             -µÄÔ­Ê¼Êý¾Ý
  266          //        }
  267          //        mpu6500_delay_ms(10);
  268          //    }
  269          //    for (i = 0; i < 3; i++)
  270          //    {
  271          //        accelBias[i] /= 500.0f; // ¼ÆËãÆ½¾ùÖµ
  272          //    }
  273          //    accelBias[2] -= 16384.0f;                               // ¼õÈ¥1gÖØÁ¦¼ÓËÙ¶È¶ÔZÖáµÄÓ°Ïì
  274          
  275          //    MPU6500_Write(0x06, (unsigned char *)&accelBias[0], 2); // ½«¼ÓËÙ¶È¼ÆXÖáµÄÆ«ÖÃÐ´ÈëMPU6500Ð¾Æ¬µÄACCE
             -L_X_OFFS_HºÍACCEL_X_OFFS_L¼Ä´æÆ÷ÖÐ
  276          //    MPU6500_Write(0x08, (unsigned char *)&accelBias[1], 2); // ½«¼ÓËÙ¶È¼ÆYÖáµÄÆ«ÖÃÐ´ÈëMPU6500Ð¾Æ¬µÄACCE
             -L_Y_OFFS_HºÍACCEL_Y_OFFS_L¼Ä´æÆ÷ÖÐ
  277          //    MPU6500_Write(0x0A, (unsigned char *)&accelBias[2], 2); // ½«¼ÓËÙ¶È¼ÆZÖáµÄÆ«ÖÃÐ´ÈëMPU6500Ð¾Æ¬µÄACCE
             -L_Z_OFFS_HºÍACCEL_Z_OFFS_L¼Ä´æÆ÷ÖÐ
  278          //}
  279          
  280          //void MPU6500_GYRO_CONFIG(){
  281          //    MPU6500_Write_u8(MPU6500_GYRO_CONFIG,MPU6500_GYRO_FS_SEL_250dps);
  282          //}


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       694     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =        24         19
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        32     ------
End of Module Information.


C251 COMPILATION COMPLETE.  3 WARNING(S),  0 ERROR(S)
